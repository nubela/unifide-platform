// Generated by CoffeeScript 1.6.3
(function() {
  var IS_COUPON_CREATING, bindCouponComposeForm, createCoupon, getCouponPage;

  this.COUPON_SESSION = {
    SUBURL: "CPSubUrl"
  };

  this.COUPON_TEMPLATE = {
    MAIN: "coupon_all",
    NEW: "coupon_compose"
  };

  this.COUPON_PAGE = {
    MAIN: "all",
    COMPOSE: "new"
  };

  IS_COUPON_CREATING = false;

  Template.coupon.rendered = function() {
    return scrollTop();
  };

  Template.coupon.view = function() {
    return Template[getCouponPage()]();
  };

  Template.coupon_compose.rendered = function() {
    Meteor.subscribe("all_groups");
    Meteor.subscribe("all_users");
    bindCouponComposeForm();
    return $("#compose-form").submit(function(evt) {
      evt.preventDefault();
      return createCoupon();
    });
  };

  Template.coupon_compose.groups = function() {
    return Group.find({}, {
      sort: {
        name: 1
      }
    });
  };

  Template.coupon_compose.events = {
    "click .submit-btn": function() {
      return $("#compose-form").submit();
    }
  };

  bindCouponComposeForm = function() {
    $("#user-applicable").change(function() {
      $(".select-specific-user").addClass("hidden");
      $(".select-user-grp").addClass("hidden");
      if ($(this).val() === "group") {
        return $(".select-user-grp").removeClass("hidden");
      } else if ($(this).val() === "specific_user") {
        return $(".select-specific-user").removeClass("hidden");
      }
    });
    $("#user").focus(function() {
      var _this = this;
      return searchUserId(function(res, userid, username, email) {
        if (res) {
          $(_this).val("" + username + " " + email);
          return $(_this).attr("data-user-id", userid);
        }
      });
    });
    $("#applicable-on").change(function() {
      $("#select-container").addClass("hidden");
      $("#container-id").removeAttr("data-required");
      $("#select-item").addClass("hidden");
      $("#item-id").removeAttr("data-required");
      if ($(this).val() === "item") {
        $("#select-item").removeClass("hidden");
        return $("#item-id").attr("data-required", "true");
      } else if ($(this).val() === "container") {
        $("#select-container").removeClass("hidden");
        return $("#container-id").attr("data-required", "true");
      }
    });
    $("#discount-lifetime-type").change(function() {
      $(".date-selectors").addClass("hidden");
      if ($(this).val() === "duration") {
        return $(".date-selectors").removeClass("hidden");
      }
    });
    $(".date-selectors").datetimepicker({
      language: 'en'
    });
    $("#item-id").focus(function() {
      var _this = this;
      return searchItemId(function(success, id, name) {
        if (success) {
          $(_this).val(name);
          return $(_this).attr("data-item-id", id);
        }
      });
    });
    return $("#container-id").focus(function() {
      var _this = this;
      return searchContainerId(function(success, id, name) {
        if (success) {
          $(_this).val(name);
          return $(_this).attr("data-container-id", id);
        }
      });
    });
  };

  getCouponPage = function() {
    var slugs;
    slugs = Session.get(COUPON_SESSION.SUBURL);
    if (slugs == null) {
      return COUPON_TEMPLATE.MAIN;
    }
    slugs = slugs.split("/");
    slugs = _.filter(slugs, function(s) {
      return s !== "";
    });
    if (slugs.length >= 1) {
      if (slugs[0] === COUPON_PAGE.COMPOSE) {
        return COUPON_TEMPLATE.NEW;
      }
    }
    return COUPON_TEMPLATE.MAIN;
  };

  createCoupon = function() {
    if ($("#coupon-compose-form").parsley("validate")) {
      if (!IS_COUPON_CREATING) {
        IS_COUPON_CREATING = true;
        return Meteor.call("new_coupon", {}, function() {
          IS_COUPON_CREATING = false;
          return Router.navigate("/coupon", true);
        });
      }
    }
  };

}).call(this);
